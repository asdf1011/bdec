<protocol>
    <common>
        <choice name="component:type">
            <field name="Y" length="8" value="0x1" />
            <field name="Cb" length="8" value="0x2" />
            <field name="Cr" length="8" value="0x3" />
            <field name="I" length="8" value="0x4" />
            <field name="Q" length="8" value="0x5" />
        </choice>

        <choice name="tiff:data:encoding">
            <field name="unsigned byte" length="16" value="0x0100" />
            <field name="ascii string" length="16" value="0x0200" />
            <field name="unsigned short" length="16" value="0x0300" />
            <field name="unsigned long" length="16" value="0x0400" />
            <field name="unsigned rational" length="16" value="0x0500" />
            <field name="signed byte" length="16" value="0x0600" />
            <field name="undefined" length="16" value="0x0700" />
            <field name="signed short" length="16" value="0x0800" />
            <field name="signed long" length="16" value="0x0900" />
            <field name="signed rational" length="16" value="0x0a00" />
            <field name="single float" length="16" value="0x0b00" />
            <field name="double float" length="16" value="0x0c00" />
            <field name="unknown" length="16" />
        </choice>

        <sequence name="image file directory">
            <field name="number of entries:"  length="16" type="integer" encoding="little endian" />
            <sequenceof name="entries" length="${number of entries:}">
                <sequence name="entry">
                    <field name="tag" length="16" type="integer" encoding="little endian" />
                    <choice name="tiff:data:encoding" />
                    <field name="number of components" length="32" type="integer" encoding="little endian" />
                    <field name="offset or value" length="32" type="hex" />
                </sequence>
            </sequenceof>
            <choice name="next ifd:">
                <field name="last ifd:" length="32" value="0x0" />
                <sequence name="another ifd:">
                    <field name="offset to next ifd:" length="32" type="integer" encoding="little endian" />
                    <field name="buffer" length="${offset to next ifd:}" type="hex" />
                    <!-- FIXME -->
                    <!--<sequence name="image file directory" />-->
                </sequence>
            </choice>
        </sequence>

        <choice name="segment:">
            <!-- Exif disabled due to the difficulty parsing the image file directory
            <sequence name="exif">
                <field name="id:" length="8" value="0xff" />
                <field name="type:" length="8" value="0xe1" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="exif:" length="48" value="0x457869660000" />
                <choice name="byte align">
                    <sequence name="intel">
                        <field name="id:" length="16" value="0x4949" />
                        <field name="length:" length="16" value="0x2a00" />
                        <field name="offset to first ifd:" length="32" type="integer" encoding="little endian" />

                        <field name="unused" length="(${offset to first ifd:} - 8) * 8" />
                        <sequence name="image file directory" />
                    </sequence>
                    <sequence name="motorola">
                        <field name="id:" length="16" value="0x4d4d" />
                        <field name="length:" length="16" value="0x002a" />
                        <field name="offset to first ifd" length="32" type="integer" encoding="big endian" /> -->
                        <!-- FIXME: Don't have big endian data structures here... -->
                <!--</sequence>
                </choice>
            </sequence>-->

            <sequence name="start of scan">
                <field name="id:" length="8" value="0xff" />
                <field name="type:" length="8" value="0xda" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="number of components:" length="8" type="integer" />
                <sequenceof name="components" length="${number of components:}">
                    <sequence name="component">
                        <choice name="component:type" />
                        <field name="huffman dc table" length="4" type="integer" />
                        <field name="huffman ac table" length="4" type="integer" />
                    </sequence>
                </sequenceof>
                <field name="unused" length="24" />
            </sequence>

            <sequence name="start of frame 0">
                <field name="id:" length="8" value="0xff" />
                <field name="type:" length="8" value="0xc0" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="data precision" length="8" type="integer" />
                <field name="image width" length="16" type="integer" encoding="big endian" />
                <field name="image height" length="16" type="integer" encoding="big endian" />
                <field name="number of components:" length="8" type="integer" />
                <sequenceof name="components">
                    <sequence name="component">
                        <sequence name="sampling factors">
                            <choice name="component:type" />
                            <field name="horizontal" length="4" type="integer" />
                            <field name="vertical" length="4" type="integer" />
                        </sequence>
                        <field name="quantization table number" length="8" type="integer" />
                    </sequence>
                </sequenceof>
            </sequence>

            <sequence name="JFIF segment marker">
                <field name="id:" length="8" value="0xff" />
                <field name="type:" length="8" value="0xe0" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="jfif:" length="40" value="0x4a46494600" />
                <field name="major revision:" length="8" value="0x1" />
                <field name="minor revision" length="8" type="integer" />
                <choice name="x/y units">
                    <field name="no units" length="8" value="0x0" />
                    <field name="dots per inch" length="8" value="0x1" />
                    <field name="dots per cm" length="8" value="0x2" />
                </choice>
                <field name="x density" length="16" type="integer" encoding="big endian" />
                <field name="y density" length="16" type="integer" encoding="big endian" />
                <sequence name="thumbnail">
                    <field name="width" length="8" type="integer" />
                    <field name="height" length="8" type="integer" />
                    <sequenceof name="rows" length="${height}">
                        <sequenceof name="row" length="${width}">
                            <sequence name="colour">
                                <field name="red" length="8" type="integer" />
                                <field name="green" length="8" type="integer" />
                                <field name="blue" length="8" type="integer" />
                            </sequence>
                        </sequenceof>
                    </sequenceof>
                </sequence>
            </sequence>

            <sequence name="define quantization table">
                <field name="id:" length="8" value="0xff" />
                <field name="type:" length="8" type="hex" value="0xdb" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="precision of qt" length="4" type="integer" />
                <field name="number of qt" length="4" type="integer" />
                <field name="quantisation table" length="64 * (${precision of qt} + 1) * 8" type="hex" />
            </sequence>

            <sequence name="define huffman table">
                <field name="id:" length="8" value="0xff" />
                <field name="type" length="8" value="0xc4" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="unused:" length="3" value="0x0" />
                <choice name="type">
                    <field name="dc table" length="1" value="0x0" />
                    <field name="ac table" length="1" value="0x1" />
                </choice>
                <field name="number of ht" length="4" type="integer" />
                <field name="counts" length="16 * 8" type="hex" />
                <field name="symbols" length="(${length} - 19) * 8" type="hex" />
            </sequence>

            <sequence name="unknown segment">
                <field name="id:" length="8" value="0xff" />
                <field name="type" length="8" type="hex" />
                <field name="length" length="16" type="integer" encoding="big endian" />
                <field name="data" length="${length} * 8 - 16" type="hex" />
            </sequence>
        </choice>
    </common>
    <sequence name="jpeg">
        <field name="soi:" length="16" value="0xffd8" />
        <sequenceof name="segments">
            <choice name="segment:" />
        </sequenceof>
        <field name="eoi:" length="16" value="0xffd9" />
    </sequence>
</protocol>
